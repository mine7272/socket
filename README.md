# νμΌ μ „μ†΅ μ‹¤μµ: TCP & WebSocket μ΅°ν•©λ³„ ν΄λΌμ΄μ–ΈνΈ/μ„λ²„ (v2)

## κ°μ”

μ΄ ν”„λ΅μ νΈλ” μ΄ 6κ°€μ§€ ν†µμ‹  μ΅°ν•©μ„ ν†µν•΄ **νμΌ μ „μ†΅ κΈ°λ¥**μ„ μ‹¤μµν•©λ‹λ‹¤.  
WebSocketμ€ ν•Έλ“μ…°μ΄ν¬ λ° ν”„λ μ„ λ§μ¤ν‚Ήμ„ μ§μ ‘ κµ¬ν„ν–μΌλ©°, μ„±λ¥ λΉ„κµλ¥Ό μ„ν•΄ **μμ‹  μ‹κ°„ μΈ΅μ •** κΈ°λ¥λ„ ν¬ν•¨λμ–΄ μμµλ‹λ‹¤.

μ΄λ² v2μ—μ„λ” **WebSocket ν”„λ μ„ λ„μ  μ²λ¦¬**, **μ„λ²„ μ§€μ† μμ‹  μ²λ¦¬**, **λ””μ½”λ”© μ¤λ¥ ν•΄κ²°**, **λ€μ©λ‰ μ•μ •μ„± κ°μ„ **,  
κ·Έλ¦¬κ³  `client_rawtcp`μ™€μ **μμ TCP ν†µμ‹  μ§€μ›**κΉμ§€ ν¬ν•¨λμ–΄ μμµλ‹λ‹¤.

---

## μ „μ²΄ ν†µμ‹  μ΅°ν•© μ •λ¦¬

| ν΄λΌμ΄μ–ΈνΈ ν”„λ΅κ·Έλ¨   | μ„λ²„ ν”„λ΅κ·Έλ¨     | μ„¤λ…                                                                  |
|------------------|------------------|---------------------------------------------------------------------|
| client_rawtcp.c  | server_tcpws.c   | WebSocketμ΄ μ•„λ‹ μμ TCP μ „μ†΅                |
| client_tcp2ws.c  | server_tcpws.c   | TCP μ—°κ²° ν›„ WebSocket ν•Έλ“μ…°μ΄ν¬ + ν”„λ μ„ λ§μ¤ν‚Ή μ μ©                          |
| client_ws2tcp.c  | server_tcpws.c   | WebSocket ν”„λ μ„λ§ μ „μ†΅ (κ°€μ§ WS ν΄λΌμ΄μ–ΈνΈ) β†’ μ„λ²„μ—μ„ ν”„λ μ„ λ””μ½”λ”© ν•„μ”       |
| client_ws.c      | server_tcpws.c   | **λΌμ΄λΈλ¬λ¦¬** κΈ°λ° ν΄λΌμ΄μ–ΈνΈ β†’ μ§μ ‘ κµ¬ν„λ WebSocket μ„λ²„                    |
| client_ws.c      | server_ws.c      | ν‘μ¤€ WebSocket **λΌμ΄λΈλ¬λ¦¬ κΈ°λ°** ν΄λΌμ΄μ–ΈνΈ                                 |
| client_tcp2ws.c  | server_ws.c      | μλ™ κµ¬ν„ ν΄λΌμ΄μ–ΈνΈ β†’ **λΌμ΄λΈλ¬λ¦¬ κΈ°λ°** WebSocket μ„λ²„                         |

---

## client_ws2tcp.c vs client_tcp2ws.c μ°¨μ΄μ 

| ν•­λ©                     | client_ws2tcp.c                            | client_tcp2ws.c                            |
|------------------------|-------------------------------------------|-------------------------------------------|
| ν•Έλ“μ…°μ΄ν¬ μν–‰ μ—¬λ¶€          | X μν–‰ν•μ§€ μ•μ (λ‹¨μ TCP μ—°κ²°)             | O WebSocket ν•Έλ“μ…°μ΄ν¬ μν–‰                  |
| WebSocket ν”„λ μ„ λ§μ¤ν‚Ή     | O μ§μ ‘ κµ¬ν„                                | O μ§μ ‘ κµ¬ν„                                |
| μ„λ²„ μ”κµ¬ μ΅°κ±΄              | μ„λ²„κ°€ WebSocket ν”„λ μ„λ§ μ²λ¦¬ κ°€λ¥ν•΄μ•Ό ν•¨         | μ„λ²„κ°€ WebSocket ν•Έλ“μ…°μ΄ν¬ λ° ν”„λ μ„ λ¨λ‘ μ²λ¦¬ κ°€λ¥ν•΄μ•Ό ν•¨ |
| ν†µμ‹  λ€μƒ μ„λ²„             | server_tcpws.c                             | server_tcpws.c, server_ws.c               |
| μ©λ„                     | WebSocketμ²λΌ λ³΄μ΄μ§€λ§ μ‹¤μ  WSκ°€ μ•„λ‹ μƒν™©        | μ‹¤μ  WebSocket ν†µμ‹  κµ¬μ΅° κ·Έλ€λ΅ μ¬ν„          |

---

## μ‹¤ν–‰ λ°©λ²• μμ‹

```bash
./server_tcpws
./server_ws

./client_rawtcp [νμΌμ΄λ¦„]
./client_tcp2ws [νμΌμ΄λ¦„]
./client_ws2tcp [νμΌμ΄λ¦„]
./client_ws [νμΌμ΄λ¦„]
```

---

## μ‹¤ν–‰ κ²°κ³Ό μμ‹ (ν…μ¤νΈ λ²„μ „)

```
μ„λ²„ μ‹¤ν–‰ μ¤‘ (ν¬νΈ 8331)...
ν΄λΌμ΄μ–ΈνΈ μ—°κ²°λ¨
[WS] handshake μ™„λ£. μμ‹  μ‹μ‘
[WS] μ΄ μμ‹  λ°”μ΄νΈ: 1017558069 / μ†μ” μ‹κ°„: 1.446383 μ΄
ν΄λΌμ΄μ–ΈνΈ μ—°κ²° μΆ…λ£

ν΄λΌμ΄μ–ΈνΈ μ—°κ²°λ¨
[TCP] μ΄ μμ‹  λ°”μ΄νΈ: 1017558069 / μ†μ” μ‹κ°„: 0.408939 μ΄
ν΄λΌμ΄μ–ΈνΈ μ—°κ²° μΆ…λ£

ν΄λΌμ΄μ–ΈνΈ μ—°κ²°λ¨
[WS] handshake μ™„λ£. μμ‹  μ‹μ‘
[WS] μ΄ μμ‹  λ°”μ΄νΈ: 1017558069 / μ†μ” μ‹κ°„: 1.544712 μ΄
ν΄λΌμ΄μ–ΈνΈ μ—°κ²° μΆ…λ£

ν΄λΌμ΄μ–ΈνΈ μ—°κ²°λ¨
[WS] handshake μ™„λ£. μμ‹  μ‹μ‘
[WS] μ΄ μμ‹  λ°”μ΄νΈ: 1017558069 / μ†μ” μ‹κ°„: 4.624147 μ΄
ν΄λΌμ΄μ–ΈνΈ μ—°κ²° μΆ…λ£
```

---

## π“ μ„λ²„ ν”„λ΅κ·Έλ¨ νΉμ§• (server_tcpws.c κΈ°μ¤€)

- WebSocket ν΄λΌμ΄μ–ΈνΈμ™€ TCP ν΄λΌμ΄μ–ΈνΈλ¥Ό λ¨λ‘ μμ‹  κ°€λ¥
- WebSocket ν•Έλ“μ…°μ΄ν¬ μ§μ ‘ κµ¬ν„ (`Sec-WebSocket-Key` β†’ SHA1 + Base64 β†’ Accept Key)
- WebSocket ν”„λ μ„ μ§μ ‘ ν•΄μ„ λ° λ§μ¤ν‚Ή ν•΄μ  μ²λ¦¬
- `recv()`μ—μ„ μλ¦° ν”„λ μ„λ„ μ²λ¦¬ κ°€λ¥ (λ„μ  λ²„νΌ + μ¤ν”„μ…‹ κΈ°λ° νμ‹±)
- `malloc` + `realloc` κΈ°λ°μΌλ΅ λ€μ©λ‰ νμΌ μμ‹  κ°€λ¥
- ν΄λΌμ΄μ–ΈνΈ μ—°κ²° μΆ…λ£ ν›„μ—λ„ μ„λ²„λ” κ³„μ† μμ‹  λ€κΈ° (`while(1)`)

---

## π¨ μ—λ¬ μ‚¬λ΅€ λ° ν•΄κ²° λ°©μ•

### 1. WebSocket ν”„λ μ„ λ””μ½”λ”© μ‹¤ν¨ (`[WS] ν”„λ μ„ λ””μ½”λ”© μ‹¤ν¨ λλ” μλ¦Ό`)
- **μ›μΈ**: recv()μ—μ„ ν”„λ μ„μ΄ λ¶„ν• λμ–΄ λ„μ°©ν•¨
- **ν•΄κ²°**: λ„μ  λ²„νΌ λ° offset κΈ°μ¤€ νμ‹± λ°©μ‹ μ μ© (v2 λ°μ)

### 2. Segmentation fault
- **μ›μΈ**: κ³ μ • λ²„νΌ(`char all_data[102400]`)λ΅λ” μ GB μμ‹  μ‹ μ¤λ²„ν”λ΅μ° λ°μƒ
- **ν•΄κ²°**: `malloc + realloc` λ°©μ‹μΌλ΅ μμ •

### 3. WebSocket ν•Έλ“μ…°μ΄ν¬ μ‹¤ν¨
- **ν„μƒ**: `101 Switching Protocols` μ‹¤ν¨
- **μ›μΈ**: ν—¤λ” λ„λ½ (`Sec-WebSocket-Key`) λλ” `Accept-Key` κ³„μ‚° μ¤λ¥
- **ν•΄κ²°**: ν΄λΌμ΄μ–ΈνΈ ν—¤λ” μ²΄ν¬, μ„λ²„μ SHA1 + Base64 λ΅μ§ κ²€μ¦

### 4. client_rawtcp β†’ server_tcpws ν†µμ‹  μ‹¤ν¨ (κ³Όκ±°)
- **ν„μƒ**: WebSocket ν‚¤ μ¶”μ¶ μ‹¤ν¨ β†’ μμ‹  λ¶κ°€
- **ν•΄κ²°**: WebSocketμ΄ μ•„λ‹ μμ TCPλ΅ μΈμ‹λμ–΄ μ΄μ  λ³„λ„ λ¶„κΈ° μ²λ¦¬ (v2 μ μ©)

---

## μ°Έκ³ 

- ν…μ¤νΈ ν¬νΈ: `127.0.0.1:8331`
- WebSocket ν”„λ μ„: RFC 6455 κΈ°λ° μλ™ μ²λ¦¬
- WebSocket μ„λ²„λ” libwebsockets μ‚¬μ© (`server_ws.c`)
- λ¨λ“  λΉλ“λ” `make` λ…λ Ήμ–΄ μ‚¬μ©

---

## μ‘μ„±μ

κΉ€λ―Όν (mine7272)  
μ—…λ°μ΄νΈ: 2025-04-01 / λ²„μ „: v2
